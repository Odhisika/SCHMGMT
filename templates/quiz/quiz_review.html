{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans 'Review' %}: {{ quiz.title }}{% endblock %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
        <li class="breadcrumb-item"><a href="{{ course.get_absolute_url }}">{{ course }}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'quiz_index' course.slug %}">{% trans 'Quizzes' %}</a></li>
        <li class="breadcrumb-item active">{% trans 'Review' %}</li>
    </ol>
</nav>

<!-- Header -->
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h2 class="mb-0">{{ quiz.title|title }}</h2>
        <p class="text-muted small mb-0">
            <i class="fas fa-lock me-1"></i>{% trans 'Read-only review' %}
            {% if not show_answers %}â€” {% trans 'correct answers hidden' %}{% endif %}
        </p>
    </div>
    {% if has_attempt and sitting %}
    <div class="card border-0 shadow-sm text-center px-4 py-3">
        <div class="fs-4 fw-bold {% if sitting.check_if_passed %}text-success{% else %}text-danger{% endif %}">
            {{ sitting.get_current_score }}/{{ sitting.get_max_score }}
        </div>
        <div class="small text-muted">{{ sitting.get_percent_correct }}%</div>
        <span class="badge {% if sitting.check_if_passed %}bg-success{% else %}bg-danger{% endif %} mt-1">
            {% if sitting.check_if_passed %}{% trans 'Passed' %}{% else %}{% trans 'Failed' %}{% endif %}
        </span>
    </div>
    {% endif %}
</div>

{% if not show_answers and quiz.show_correct_answers_after %}
<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle me-2"></i>
    {% trans 'Correct answers will be revealed on' %}: <strong>{{ quiz.show_correct_answers_after|date:"N j, Y g:i A" }}</strong>
</div>
{% endif %}

<!-- Questions -->
<div class="row justify-content-center">
    <div class="col-lg-9">
        {% for question in questions %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center bg-white border-bottom">
                <span class="fw-semibold text-muted small">{% trans 'Question' %} {{ forloop.counter }}</span>
                {% if has_attempt and show_answers %}
                    {% if question.id|stringformat:"s" in sitting.user_answers %}
                        {% with user_answer=sitting.user_answers|slice:"0" %}
                        {% endwith %}
                        {% if question.check_if_correct %}
                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>{% trans 'Correct' %}</span>
                        {% else %}
                        <span class="badge bg-danger"><i class="fas fa-times me-1"></i>{% trans 'Incorrect' %}</span>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
            <div class="card-body">
                {% if question.figure %}
                <img src="{{ question.figure.url }}" class="img-fluid rounded mb-3" alt="">
                {% endif %}
                <p class="fw-medium mb-3">{{ question.content }}</p>

                <!-- Answer choices -->
                {% if question.get_choices %}
                <div class="list-group list-group-flush">
                    {% for choice_id, choice_text in question.get_choices_list %}
                    <div class="list-group-item border-0 px-0 py-1 d-flex align-items-center gap-2
                        {% if show_answers and choice_id|stringformat:"s" == question.correct_choice %}text-success fw-semibold{% endif %}">
                        <span class="badge bg-light text-dark border">{{ forloop.counter|add:"64"|chr }}</span>
                        {{ choice_text }}
                        {% if show_answers and choice_id == question.user_answer|add:0 %}
                        <span class="ms-auto badge bg-primary">{% trans 'Your answer' %}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if question.explanation and show_answers %}
                <div class="mt-3 p-3 bg-light rounded">
                    <small class="text-muted d-block fw-semibold mb-1">{% trans 'Explanation' %}</small>
                    <small>{{ question.explanation }}</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p class="text-muted text-center py-5">{% trans 'No questions to display.' %}</p>
        {% endfor %}

        <div class="text-center mt-4 mb-5">
            <a href="{% url 'quiz_index' course.slug %}" class="btn btn-light px-5">
                <i class="fas fa-arrow-left me-2"></i>{% trans 'Back to Quizzes' %}
            </a>
        </div>
    </div>
</div>

{% endblock %}
