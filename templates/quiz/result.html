{% extends "base.html" %}
{% load i18n %}
{% load quiz_tags %}

{% block title %} {{ quiz.title}} | {% trans 'Learning management system' %} {% endblock %}
{% block description %} {% trans "Quiz Results for" %} {{ quiz.title }} {% endblock %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
	<ol class="breadcrumb">
		<li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
		<li class="breadcrumb-item"><a href="{% url 'programs' %}">{% trans 'Programs' %}</a></li>
		<li class="breadcrumb-item"><a href="{% url 'program_detail' course.program.id %}">{{ course.program }}</a></li>
		<li class="breadcrumb-item"><a href="{{ course.get_absolute_url }}">{{ course }}</a></li>
		<li class="breadcrumb-item"><a href="{% url 'quiz_index' course.slug %}">{% trans 'Quizzes' %}</a></li>
		<li class="breadcrumb-item active" aria-current="page">{% trans 'Result' %}</li>
	</ol>
</nav>

<div class="container">
	<!-- Results Summary Card -->
	<div class="row justify-content-center mt-4">
		<div class="col-lg-8">
			<div class="card shadow-sm">
				<div class="card-header bg-primary text-white text-center py-3">
					<h4 class="mb-0">{% trans "Quiz Completed!" %}</h4>
				</div>
				<div class="card-body text-center p-5">
					<h5 class="mb-4">{{ quiz.title }}</h5>
					
					<!-- Score Display -->
					<div class="row mb-4">
						<div class="col-md-4">
							<div class="border rounded p-3">
								<h6 class="text-muted small">{% trans "Your Score" %}</h6>
								<h2 class="mb-0 {% if percent >= quiz.pass_mark %}text-success{% else %}text-danger{% endif %}">
									{{ percent }}%
								</h2>
							</div>
						</div>
						<div class="col-md-4">
							<div class="border rounded p-3">
								<h6 class="text-muted small">{% trans "Correct Answers" %}</h6>
								<h2 class="mb-0">{{ score }}/{{ max_score }}</h2>
							</div>
						</div>
						<div class="col-md-4">
							<div class="border rounded p-3">
								<h6 class="text-muted small">{% trans "Status" %}</h6>
								<h2 class="mb-0">
									{% if percent >= quiz.pass_mark %}
										<i class="fas fa-check-circle text-success"></i>
									{% else %}
										<i class="fas fa-times-circle text-danger"></i>
									{% endif %}
								</h2>
							</div>
						</div>
					</div>

					<!-- Pass/Fail Message -->
					{% if quiz.pass_mark %}
					<div class="alert {% if percent >= quiz.pass_mark %}alert-success{% else %}alert-warning{% endif %} mb-4">
						<h5 class="alert-heading">
							{% if percent >= quiz.pass_mark %}
								<i class="fas fa-trophy me-2"></i>{% trans "Congratulations! You passed!" %}
							{% else %}
								<i class="fas fa-info-circle me-2"></i>{% trans "Keep practicing!" %}
							{% endif %}
						</h5>
						<p class="mb-0">
							{% if percent >= quiz.pass_mark %}
								{% blocktrans with pass_mark=quiz.pass_mark %}You scored above the pass mark of {{ pass_mark }}%{% endblocktrans %}
							{% else %}
								{% blocktrans with pass_mark=quiz.pass_mark %}You need {{ pass_mark }}% to pass. Review the questions and try again.{% endblocktrans %}
							{% endif %}
						</p>
					</div>
					{% endif %}

					<!-- Action Buttons -->
					<div class="d-grid gap-2 d-md-flex justify-content-md-center">
						<a href="{% url 'quiz_index' course.slug %}" class="btn btn-primary">
							<i class="fas fa-list me-1"></i>{% trans "Back to Quizzes" %}
						</a>
						<a href="{% url 'quiz_progress' %}" class="btn btn-outline-primary">
							<i class="fas fa-chart-line me-1"></i>{% trans "View Progress" %}
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Question Review (if answers_at_end is True) -->
	{% if questions %}
	<div class="row justify-content-center mt-4">
		<div class="col-lg-10">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0">{% trans "Question Review" %}</h5>
				</div>
				<div class="card-body">
					{% for question in questions %}
					<div class="question-review mb-4 {% if not forloop.last %}pb-4 border-bottom{% endif %}">
						<div class="d-flex justify-content-between align-items-start mb-3">
							<h6 class="mb-0">
								<span class="badge bg-secondary me-2">Q{{ forloop.counter }}</span>
								{{ question.content }}
							</h6>
							{% if question.id in incorrect_questions %}
							<span class="badge bg-danger">{% trans "Incorrect" %}</span>
							{% else %}
							<span class="badge bg-success">{% trans "Correct" %}</span>
							{% endif %}
						</div>

						{% if question.figure %}
						<div class="mb-3">
							<img src="{{ question.figure.url }}" alt="{{ question.content }}" class="img-fluid rounded" style="max-width: 400px;"/>
						</div>
						{% endif %}

						<!-- Show correct answer -->
						{% correct_answer_for_all question %}

						<!-- Show user's answer -->
						{% if question.user_answer %}
						<p class="mt-2">
							<strong>{% trans "Your answer" %}:</strong>
							<span class="{% if question.id not in incorrect_questions %}text-success{% else %}text-danger{% endif %}">
								{{ question|answer_choice_to_string:question.user_answer }}
							</span>
						</p>
						{% endif %}

						<!-- Explanation -->
						{% if question.explanation %}
						<div class="alert alert-info mt-3 mb-0">
							<strong><i class="fas fa-lightbulb me-1"></i>{% trans "Explanation" %}:</strong>
							{{ question.explanation|safe }}
						</div>
						{% endif %}
					</div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
	{% endif %}
</div>

{% endblock %}

{% block js %}
<script>
	// Confetti animation for passing scores
	{% if percent >= quiz.pass_mark %}
	// Simple confetti effect (optional - requires external library or custom implementation)
	console.log('ðŸŽ‰ Congratulations! You passed!');
	{% endif %}
</script>
{% endblock js %}
