{% extends "base.html" %}
{% load i18n%}

{% block title %} {{ quiz.title }} | {% trans 'Learning management system' %} {% endblock %}
{% block description %} {{ quiz.title }} - {{ quiz.description }} {% endblock %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
	<ol class="breadcrumb">
		<li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
		<li class="breadcrumb-item"><a href="{% url 'programs' %}">Programs</a></li>
		<li class="breadcrumb-item"><a href="{% url 'program_detail' course.program.id %}">{{ course.program }}</a></li>
		<li class="breadcrumb-item"><a href="{{ course.get_absolute_url }}">{{ course }}</a></li>
		<li class="breadcrumb-item"><a href="{% url 'quiz_index' course.slug %}">{% trans 'Quizzes' %}</a></li>
		<li class="breadcrumb-item active" aria-current="page">{{ quiz.title|title }}</li>
	</ol>
</nav>

<div class="container-fluid">
	<div class="row">
		<!-- Main Quiz Area -->
		<div class="col-lg-9">
			<div class="card mb-3">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h5 class="mb-0">{{ quiz.title|title }}</h5>
					{% if show_timer %}
					<div id="timer-display" class="badge bg-danger fs-6 px-3 py-2">
						<i class="fas fa-clock me-1"></i>
						<span id="timer-minutes">--</span>:<span id="timer-seconds">--</span>
					</div>
					{% endif %}
				</div>
				<div class="card-body">
					{% if progress %}
					<div class="mb-3">
						<small class="text-muted">{% trans "Question" %} {{ progress.0|add:1 }} {% trans "of" %} {{ progress.1 }}</small>
						<div class="progress" style="height: 5px;">
							<div class="progress-bar" role="progressbar" style="width: {% widthratio progress.0 progress.1 100 %}%"></div>
						</div>
					</div>
					{% endif %}

					{% if question %}
					<div class="question-content">
						<h4 class="mb-4">{{ question.content }}</h4>

						{% if question.figure %}
						<div class="text-center mb-4">
							<img src="{{ question.figure.url }}" alt="{{ question.content }}" class="img-fluid rounded" style="max-width: 600px;"/>
						</div>
						{% endif %}

						<form id="quiz-form" method="POST">{% csrf_token %}
							<input type="hidden" name="question_id" value="{{ question.id }}">

							<div class="answer-choices">
								{% for answer in form.answers %}
								<div class="form-check answer-option mb-3">
									{{ answer }}
								</div>
								{% endfor %}
							</div>

							<div class="d-flex justify-content-between mt-4">
								<button type="button" class="btn btn-outline-secondary" disabled>
									<i class="fas fa-arrow-left me-1"></i> {% trans "Previous" %}
								</button>
								<button type="submit" class="btn btn-primary btn-lg">
									{% trans "Submit Answer" %} <i class="fas fa-arrow-right ms-1"></i>
								</button>
							</div>
						</form>
					</div>
					{% endif %}
				</div>
			</div>

			<!-- Previous Answer Feedback -->
			{% if previous.answers %}
			<div class="card mb-3">
				<div class="card-header {% if previous.previous_outcome %}bg-success text-white{% else %}bg-warning{% endif %}">
					<i class="fas {% if previous.previous_outcome %}fa-check-circle{% else %}fa-times-circle{% endif %} me-2"></i>
					{% trans "Previous Question" %}: {{ previous.previous_outcome|yesno:"Correct,Incorrect" }}
				</div>
				<div class="card-body">
					<p class="fw-bold">{{ previous.previous_question }}</p>
					
					{% if previous.answers %}
					<table class="table table-sm">
						<tbody>
							{% for answer in previous.answers %}
							{% if answer.correct %}
							<tr class="table-success">
								<td>{{ answer }}</td>
								<td class="text-end"><i class="fas fa-check text-success"></i> {% trans "Correct Answer" %}</td>
							</tr>
							{% else %}
							<tr>
								<td>{{ answer }}</td>
								<td class="text-end">
									{% if previous.question_type.MCQuestion %}
										{% if answer.id|add:"0" == previous.previous_answer|add:"0" %}
											<i class="fas fa-times text-danger"></i> {% trans "Your Answer" %}
										{% endif %}
									{% endif %}
								</td>
							</tr>
							{% endif %}
							{% endfor %}
						</tbody>
					</table>
					{% endif %}

					{% if previous.previous_question.explanation %}
					<div class="alert alert-info mt-3">
						<strong>{% trans "Explanation" %}:</strong> {{ previous.previous_question.explanation }}
					</div>
					{% endif %}
				</div>
			</div>
			{% endif %}
		</div>

		<!-- Sidebar: Question Palette & Info -->
		<div class="col-lg-3">
			<div class="card sticky-top" style="top: 20px;">
				<div class="card-header">
					<h6 class="mb-0">{% trans "Quiz Info" %}</h6>
				</div>
				<div class="card-body">
					<p class="mb-2"><small class="text-muted">{% trans "Category" %}:</small></p>
					<p class="mb-3"><span class="badge bg-primary">{{ quiz.category|title }}</span></p>

					{% if quiz.time_limit_minutes %}
					<p class="mb-2"><small class="text-muted">{% trans "Time Limit" %}:</small></p>
					<p class="mb-3">{{ quiz.time_limit_minutes }} {% trans "minutes" %}</p>
					{% endif %}

					{% if quiz.single_attempt %}
					<div class="alert alert-warning small">
						<i class="fas fa-exclamation-triangle me-1"></i> {% trans "Single attempt only" %}
					</div>
					{% endif %}

					<!-- Question Palette (Future Enhancement)
					<hr>
					<p class="mb-2"><small class="text-muted">{% trans "Questions" %}:</small></p>
					<div class="question-palette">
						<div class="d-grid gap-2" style="grid-template-columns: repeat(5, 1fr);">
							{% for i in "12345678901234567890"|make_list %}
							<button class="btn btn-sm btn-outline-secondary">{{ forloop.counter }}</button>
							{% endfor %}
						</div>
					</div>
					-->
				</div>
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block js %}
{% if show_timer %}
<script>
	// Timer initialized from server - always a positive number for new sittings
	let timeRemaining = {{ time_remaining_seconds|default:0 }};
	const timerDisplay = document.getElementById('timer-display');
	const timerMinutes = document.getElementById('timer-minutes');
	const timerSeconds = document.getElementById('timer-seconds');

	function updateTimer() {
		if (timeRemaining < 0) timeRemaining = 0;

		const minutes = Math.floor(timeRemaining / 60);
		const seconds = timeRemaining % 60;
		
		timerMinutes.textContent = minutes.toString().padStart(2, '0');
		timerSeconds.textContent = seconds.toString().padStart(2, '0');

		// At 5 minutes → turn orange
		if (timeRemaining <= 300 && timeRemaining > 60) {
			timerDisplay.classList.remove('bg-danger');
			timerDisplay.classList.add('bg-warning', 'text-dark');
		}
		
		// At 1 minute → back to red + pulse
		if (timeRemaining <= 60) {
			timerDisplay.classList.remove('bg-warning', 'text-dark');
			timerDisplay.classList.add('bg-danger', 'pulse');
		}
		
		// Time up — auto-submit
		if (timeRemaining <= 0) {
			clearInterval(timerInterval);
			timerDisplay.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i> TIME UP';
			setTimeout(function() {
				document.getElementById('quiz-form').submit();
			}, 1500);
			return;
		}
		
		timeRemaining--;
	}
	
	// Run immediately so display shows right away
	updateTimer();
	const timerInterval = setInterval(updateTimer, 1000);
	
	// Warn on page close
	window.addEventListener('beforeunload', function (e) {
		e.preventDefault();
		e.returnValue = '';
	});
</script>

<style>
	@keyframes pulse {
		0%, 100% { opacity: 1; transform: scale(1); }
		50% { opacity: 0.85; transform: scale(1.03); }
	}
	.pulse {
		animation: pulse 0.8s infinite;
	}
</style>
{% endif %}

{% if progress.0|add:1 == 1 %}
<script>
	// Show instruction modal on first question
	const instructionModal = new bootstrap.Modal(document.getElementById('instructionModal'), {
		keyboard: false
	});
	
	// Auto-show modal
	window.addEventListener('load', function() {
		instructionModal.show();
	});
</script>

<!-- Instructions Modal -->
<div class="modal fade" id="instructionModal" tabindex="-1" aria-labelledby="instructionModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="instructionModalLabel">{% trans 'Quiz Instructions' %}</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<ul>
					{% if quiz.time_limit_minutes %}
					<li>{% blocktrans with time=quiz.time_limit_minutes %}This quiz has a time limit of {{ time }} minutes.{% endblocktrans %}</li>
					<li>{% trans "The timer will countdown automatically." %}</li>
					<li>{% trans "Your quiz will be auto-submitted when time expires." %}</li>
					{% endif %}
					{% if not quiz.answers_at_end %}
					<li>{% trans "You can't go back to previous questions after submitting." %}</li>
					<li>{% trans "Double-check your answers before submitting!" %}</li>
					{% endif %}
					{% if quiz.single_attempt %}
					<li><strong>{% trans "You only get ONE attempt at this quiz." %}</strong></li>
					{% endif %}
				</ul>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" data-bs-dismiss="modal">{% trans 'I Understand - Start Quiz' %}</button>
			</div>
		</div>
	</div>
</div>
{% endif %}

<style>
	.answer-option label {
		display: block;
		padding: 15px;
		border: 2px solid #e0e0e0;
		border-radius: 8px;
		cursor: pointer;
		transition: all 0.2s;
	}
	
	.answer-option:hover label {
		border-color: #007bff;
		background-color: #f8f9fa;
	}
	
	.answer-option input[type="radio"]:checked + label,
	.answer-option input[type="radio"]:checked ~ label {
		border-color: #007bff;
		background-color: #e7f3ff;
		font-weight: 500;
	}
	
	.sticky-top {
		position: sticky;
	}
</style>
{% endblock js %}
