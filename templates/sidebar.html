{% load static %}
{% load i18n %}

<div id="side-nav" class="professional-sidebar">
	<div class="main-menu">
		<div class="top-side text-center py-3">
			<div class="desktop-hide">
				<div class="toggle-btn" onclick="toggleSidebar()">
					<i class="fas fa-times"></i>
				</div>
			</div>
			<a href="/" class="d-block mb-2">
				<img src="{% static 'img/logo.jpeg' %}" class="sidebar-logo" alt="SkyLearn">
			</a>
			<div class="user-role-badge">
				<span class="role-text">{{ request.user.get_user_role }}</span>
			</div>
		</div>
		{% url 'home' as hom %} {% url 'dashboard' as dash %} {% url 'profile' as prof %}
		{% url 'lecturer_list' as lec %}
		{% url 'student_list' as stu %} {% url 'course_allocation_view' as cav %}
		{% url 'programs' as pro %} {% url 'semester_list' as sem %} {% url 'timetable:timetable_dashboard' as ttable %}
		{% url 'add_score' as ascore %} {% url 'grade_results' as vr %}{% url 'ass_results' as ar %}
		{% url 'course_registration' as cr %} {% url 'edit_profile' as ep %} {% url 'change_password' as cp %}
		{% url 'quiz_progress' as qpr %} {% url 'quiz_marking' as qce %} {% url 'user_course_list' as ucl %}
		{% url 'admin_panel' as admin_p %}
		


		<ul hx-target="#main-content" hx-select="#main-content" hx-swap="innerHTML show:window:top" hx-push-url="true">
			{% if request.user.is_superuser or request.user.is_school_admin %}
			<li class="{% if request.path == dash %}active{% endif %}">
				<a href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i>{% trans 'Dashboard' %}</a>
			</li>
			{% endif %}
			<li class="{% if request.path == hom %}active{% endif %}">
				<a href="{% url 'home' %}"><i class="fas fa-home"></i>{% trans 'Home' %}</a>
			</li>
			<li class="{% if request.path == prof %}active{% endif %}">
				<a href="{% url 'profile' %}"><i class="fas fa-user"></i>{% trans 'Profile' %}</a>
			</li>

			{% if request.user.is_superuser %}
			<li class="{% if request.path == admin_p %}active{% endif %}">
				<a href="{% url 'admin_panel' %}"><i class="fas fa-user-tie"></i>{% trans 'Admin Panel' %}</a>
			</li>
			<li class="{% if 'school' in request.path %}active{% endif %}">
				<a href="{% url 'school_list' %}"><i class="fas fa-university"></i>{% trans 'Manage Schools' %}</a>
			</li>
			{% endif %}
			
			{% if request.user.is_superuser or request.user.is_school_admin %}
			<li class="{% if request.path == lec %}active{% endif %}">
				<a href="{% url 'lecturer_list' %}"><i class="fas fa-chalkboard-teacher"></i>{% trans 'Teachers' %}</a>
			</li>
			{% endif %}

			{% if request.user.is_superuser or request.user.is_school_admin or request.user.is_lecturer or request.user.is_teacher %}
			<li class="{% if '/accounts/classes/' in request.path %}active{% endif %}">
				<a href="{% url 'class_list' %}"><i class="fas fa-layer-group"></i>{% trans 'Classes & Students' %}</a>
			</li>
			{% endif %}

			{% if request.user.is_lecturer or request.user.is_teacher or request.user.is_student %}
			<li class="{% if request.path == ucl %}active{% endif %}">
				<a href="{% url 'user_course_list' %}"><i class="fas fa-book"></i>{% trans 'My Subjects' %}</a>
			</li>
			<li class="{% if request.path == ttable %}active{% endif %}">
				<a href="{% url 'timetable:timetable_dashboard' %}"><i class="fas fa-calendar-alt"></i>{% trans 'Timetable' %}</a>
			</li>
			{% endif %}

			{% if request.user.is_superuser or request.user.is_school_admin or request.user.is_lecturer or request.user.is_teacher %}
			<li class="{% if '/attendance/' in request.path %}active{% endif %}">
				<a href="{% url 'attendance:dashboard' %}"><i class="fas fa-clipboard-check"></i>{% trans 'Attendance' %}</a>
			</li>
			{% endif %}

			{% if request.user.is_student or request.user.is_superuser or request.user.is_school_admin %}
			<li class="{% if '/fees/' in request.path %}active{% endif %}">
				<a href="{% url 'fees:dashboard' %}"><i class="fas fa-money-bill-wave"></i>{% trans 'Payments' %}</a>
			</li>
			{% endif %}

			{% if request.user.is_superuser or request.user.is_school_admin or request.user.is_lecturer or request.user.is_teacher %}
			<li class="{% if request.path == pro %}active{% endif %}">
				<a href="{% url 'programs' %}"><i class="fas fa-book-open"></i>{% trans 'Classes & Subjects' %}</a>
			</li>
			{% endif %}

			{% if request.user.is_superuser or request.user.is_school_admin or request.user.is_lecturer or request.user.is_teacher %}
			<li class="{% if request.path == qce %}active{% endif %}">
				<a href="{% url 'quiz_marking' %}"><i class="fas fa-check-double"></i>{% trans 'Complete Exams' %}</a>
			</li>
			{% endif %}

			{% if request.user.is_superuser or request.user.is_school_admin %}
			<li class="{% if request.path == qpr %}active{% endif %}">
				<a href="{% url 'quiz_progress' %}"><i class="fas fa-record-vinyl"></i>{% trans 'Quiz Progress Rec' %}</a>
			</li>
			<li class="{% if request.path == cav %}active{% endif %}">
				<a href="{% url 'course_allocation_view' %}"><i class="fas fa-tasks"></i>{% trans 'Subject Allocation' %}</a>
			</li>

			<li class="{% if request.path == sem %}active{% endif %}">
				<a href="{% url 'semester_list' %}"><i class="fas fa-calendar-alt"></i>{% trans 'Manage Terms' %}</a>
			</li>
			<li class="{% if '/result/report-cards/' in request.path %}active{% endif %}">
				<a href="{% url 'report_cards' %}"><i class="fas fa-file-invoice"></i>{% trans 'Report Cards' %}</a>
			</li>
			<li class="{% if '/result/promotion/' in request.path %}active{% endif %}">
				<a href="{% url 'create_promotion' %}"><i class="fas fa-graduation-cap"></i>{% trans 'Promote Students' %}</a>
			</li>
			<li class="{% if '/result/manage-score/requests/' in request.path %}active{% endif %}">
				<a href="{% url 'result_amendment_requests' %}"><i class="fas fa-clipboard-check"></i>{% trans 'Result Requests' %}</a>
			</li>
			<li class="{% if request.path == ttable %}active{% endif %}">
				<a href="{% url 'timetable:timetable_dashboard' %}"><i class="fas fa-calendar-alt"></i>{% trans 'Timetable' %}</a>
			</li>
			{% endif %}

			{% if request.user.is_superuser or request.user.is_school_admin %}
			<li class="{% if '/admin/lesson-notes/' in request.path %}active{% endif %}">
				<a href="{% url 'lesson_note_admin_list' %}"><i class="fas fa-clipboard-list"></i>{% trans 'Review Lesson Notes' %}</a>
			</li>
			{% endif %}

			{% if request.user.is_lecturer or request.user.is_teacher %}
			<li class="{% if request.path == ascore %}active{% endif %}">
				<a href="{% url 'add_score' %}"><i class="fas fa-table"></i>{% trans 'Manage Scores' %}</a>
			</li>
			<li class="{% if '/lesson-notes/' in request.path and '/admin/' not in request.path %}active{% endif %}">
				<a href="{% url 'lesson_note_list' %}"><i class="fas fa-book-reader"></i>{% trans 'Lesson Notes' %}</a>
			</li>
			<li class="{% if '/result/manage-score/requests/' in request.path %}active{% endif %}">
				<a href="{% url 'result_amendment_requests' %}"><i class="fas fa-clipboard-check"></i>{% trans 'Result Requests' %}</a>
			</li>
			<li class="{% if request.path == ucl %}active{% endif %}">
				<a href="{% url 'user_course_list' %}"><i class="fas fa-list-alt"></i>{% trans 'Quizzes' %}</a>
			</li>
			{% endif %}

			{% if request.user.is_student %}
			<li class="{% if request.path == qpr %}active{% endif %}">
				<a href="{% url 'quiz_progress' %}"><i class="fas fa-record-vinyl"></i>{% trans 'Quiz Progress Rec' %}</a>
			</li>
			<li class="{% if request.path == ucl %}active{% endif %}">
				<a href="{% url 'user_course_list' %}"><i class="fas fa-list-alt"></i>{% trans 'Quizzes' %}</a>
			</li>
			<li class="{% if request.path == vr %}active{% endif %}">
				<a href="{% url 'grade_results' %}"><i class="fa fa-spell-check"></i>{% trans 'Report Card' %}</a>
			</li>
			<li class="{% if request.path == ar %}active{% endif %}">
				<a href="{% url 'ass_results' %}"><i class="fa fa-list-ol"></i> {% trans 'Assessment Results' %}</a>
			</li>

			{% endif %}
			<br />
			<p class="ms-3 text-secondary">&RightArrow; Others</p>
			<li class="{% if request.path == ep %}active{% endif %}">
				<a href="{% url 'edit_profile' %}"><i class="fas fa-cogs"></i>{% trans 'Account Setting' %}</a>
			</li>
			<li class="{% if request.path == cp %}active{% endif %}">
				<a href="{% url 'change_password' %}"><i class="fas fa-key"></i>{% trans 'Change Password' %}</a>
			</li>
		</ul>
	</div>

	<footer class="card-footer mt-5 pt-3 pb-5 px-2"></footer>
	<!-- #All right reserver lig dev team  -->
	 <p>
		All right reserved &copy; <script>document.write(new Date().getFullYear());</script> lig dev team
		<br />
		<a href="#">ligdevteam</a>
	 </p>
</div>

{% block js %}
<script>
	const langSelect = document.getElementById("lang-select");
	if (langSelect) {
		langSelect.addEventListener("change", function() {
			console.log("Changed!")
			document.getElementById("lang-form").submit();  // Submit the form programmatically
		});
	}

	// Sidebar Scroll and State Management
	document.addEventListener("DOMContentLoaded", function() {
		const sidebar = document.getElementById('side-nav');
		const key = 'schmgmt_sidebar_pos';
		const DEBUG = false; // Set to true for debugging

		if (!sidebar) return;

		function log(msg) {
			if (DEBUG) console.log("[Sidebar]", msg);
		}

		// 1. Find or Set Active Item based on URL
		function markActiveItem() {
			let activeItem = sidebar.querySelector('.active');
			if (!activeItem) {
				const currentPath = window.location.pathname;
				log("No server-side active item found. Checking Path: " + currentPath);
				
				const links = sidebar.querySelectorAll('a');
				for (const link of links) {
					const href = link.getAttribute('href');
					// Check exact match or sub-path match
					if (href === currentPath || (href !== '/' && currentPath.startsWith(href))) {
						activeItem = link.parentElement;
						activeItem.classList.add('active');
						log("Found matching link: " + href);
						break;
					}
				}
			} else {
				log("Server-side active item found.");
			}
			return activeItem;
		}

		// 2. Restore Scroll Position
		function restoreSidebarState() {
			const activeItem = markActiveItem();
			const savedPos = sessionStorage.getItem(key);

			if (savedPos && parseInt(savedPos) > 0) {
				sidebar.scrollTop = parseInt(savedPos);
				log("Restored scroll position: " + savedPos);
			}
			
			// 3. Force Active Item into View
			if (activeItem) {
				log("Scrolling active item into view");
				// Use timeout to ensure layout is done
				setTimeout(() => {
					activeItem.scrollIntoView({ block: 'center', behavior: 'auto' });
				}, 100);
			}
		}

		// Run logic
		restoreSidebarState();
		
		// Run again after a delay to handle layout shifts (images, etc)
		setTimeout(restoreSidebarState, 500);

		// Save position on scroll
		sidebar.addEventListener('scroll', function() {
			sessionStorage.setItem(key, sidebar.scrollTop);
		});
	});
</script>
{% endblock js %}