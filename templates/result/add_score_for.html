{% extends 'base.html' %}
{% load i18n %}
{% block title %}{{ title }} | {% trans 'Learning management system' %}{% endblock title %}
{% load static %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
        <li class="breadcrumb-item"><a href="{{ course.get_absolute_url }}">{{ course }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{% trans 'Manage Score' %}</li>
    </ol>
</nav>

<div class="dropdown">
    <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        {{ course }}
    </button>
    <div class="dropdown-menu">
        {% for course in courses %}
            <a class="dropdown-item" href="{% url 'add_score_for' course.id %}" title="{{ course.code }}">{{ course.title }}</a>
        {% empty %}
            <p class="dropdown-item">{% trans 'No course.' %}</p>
        {% endfor %}
    </div>
</div>

<br>
<h4 class="title-1">{% trans 'Students result form' %} | {{ course|truncatechars:15 }}</h4>
<p>{{ course.summary }}</p>

{% include 'snippets/messages.html' %}

<form action="" method="POST">
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="btn-group">
            {% if not is_locked %}
            <button title="Save Score" type="submit" class="btn btn-primary"><i class="fas fa-save"></i> {% trans 'Save Scores' %}</button>
            {% else %}
            <button class="btn btn-secondary" disabled><i class="fas fa-lock"></i> {% trans 'Results Locked' %}</button>
            {% endif %}
            
            <a target="_blank" href="{% url 'result_sheet_pdf_view' id=course.id %}" class="btn btn-warning">
                <i class="far fa-file-pdf"></i> {% trans 'Print BroadSheet' %}
            </a>
        </div>

        {% if is_locked %}
            {% if edit_request %}
                <div class="alert alert-info py-2 px-3 m-0 d-inline-block">
                    <strong>{% trans 'Edit Request Status:' %}</strong> 
                    <span class="badge {% if edit_request.status == 'Pending' %}bg-warning{% elif edit_request.status == 'Approved' %}bg-success{% else %}bg-danger{% endif %} text-dark">
                        {{ edit_request.status }}
                    </span>
                    {% if edit_request.status == 'Approved' %}
                    <span class="small">({% trans 'Unlocked!' %})</span>
                    {% endif %}
                </div>
            {% else %}
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#requestEditModal">
                    <i class="fas fa-unlock-alt"></i> {% trans 'Request Admin to Unlock' %}
                </button>
            {% endif %}
        {% endif %}
    </div>

    <h4 class="mt-3">{{ current_term.term }} <i class="text-light px-2 rounded small bg-danger">{{ current_session }}</i></h4>
    
    {% if is_locked %}
    <div class="alert alert-danger bg-danger text-white">
        <i class="fas fa-lock"></i> 
        {% trans 'Results for this term have been published. Changes are restricted.' %} 
        {% trans 'Contact Admin for approval to make amendments.' %}
    </div>
    {% endif %}

    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>{% trans 'Student' %}</th>
                    <th>{% trans 'Class Score (40%)' %}</th>
                    <th>{% trans 'Exam Score (60%)' %}</th>
                    <th>{% trans 'Total' %}</th>
                    <th>{% trans 'Grade' %}</th>
                    <th>{% trans 'Comment' %}</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            {% if student.student.student.picture %}
                            <img src="{{ student.student.student.picture.url }}" class="rounded-circle me-2" style="width: 30px; height: 30px;">
                            {% endif %}
                            <div>
                                <div class="fw-bold">{{ student.student.student.get_full_name }}</div>
                                <div class="small text-muted">{{ student.student.student.username }}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <input type="number" step="0.01" max="40" name="{{ student.id }}-class_score" value="{{ student.class_score }}" class="form-control form-control-sm" style="width: 100px;" {% if is_locked %}disabled{% endif %}>
                    </td>
                    <td>
                        <input type="number" step="0.01" max="60" name="{{ student.id }}-exam_score" value="{{ student.exam_score }}" class="form-control form-control-sm" style="width: 100px;" {% if is_locked %}disabled{% endif %}>
                    </td>
                    <td class="fw-bold fs-6">{{ student.total }}</td>
                    <td><span class="badge {% if student.grade == '9' %}bg-danger{% elif student.grade <= '4' %}bg-success{% else %}bg-warning{% endif %}">{{ student.grade }}</span></td>
                    <td class="small">{{ student.comment }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <i class="fas fa-users-slash fa-2x text-muted mb-2"></i>
                        <p class="text-muted">{% trans 'No students found enrolled in this course.' %}</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>

<!-- Unlock Request Modal -->
<div class="modal fade" id="requestEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" class="modal-content">
            {% csrf_token %}
            <input type="hidden" name="request_edit" value="true">
            <div class="modal-header">
                <h5 class="modal-title">{% trans 'Request Permission to Edit' %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{% trans 'Reason for Amendment' %}</label>
                    <textarea name="reason" class="form-control" rows="3" required placeholder="e.g. Data entry error for Student X..."></textarea>
                    <div class="form-text">{% trans 'Admin approval is required to modify results after publication.' %}</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancel' %}</button>
                <button type="submit" class="btn btn-danger">{% trans 'Submit Request' %}</button>
            </div>
        </form>
    </div>
</div>

{% endblock content %}
