{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{{ title }} | {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
        <a href="{% url 'manage_scores' %}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to Dashboard
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Subject</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ course.title }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-book fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Students</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ taken_courses.count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Score Entry Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Student Scores</h6>
            <button id="saveScoresBtn" class="btn btn-primary btn-sm">
                <i class="fas fa-save fa-sm text-white-50"></i> Save All Changes
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="scoresTable" width="100%" cellspacing="0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%">#</th>
                            <th style="width: 25%">Student Name</th>
                            <th style="width: 15%">Midsem (10%)</th>
                            <th style="width: 15%">Quiz (15%)</th>
                            <th style="width: 15%">Assign (15%)</th>
                            <th style="width: 15%">Exam (60%)</th>
                            <th style="width: 10%">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tc in taken_courses %}
                        <tr data-id="{{ tc.id }}">
                            <td>{{ forloop.counter }}</td>
                            <td class="align-middle">
                                <span class="fw-bold">{{ tc.student.student.get_full_name }}</span>
                                <br>
                                <small class="text-muted">{{ tc.student.student.username }}</small>
                            </td>
                            <td>
                                <input type="number" class="form-control score-input midsem" 
                                       value="{{ tc.midsem_score }}" min="0" max="100" step="0.01">
                            </td>
                            <td>
                                <input type="number" class="form-control score-input quiz" 
                                       value="{{ tc.quiz_score }}" min="0" max="100" step="0.01">
                            </td>
                            <td>
                                <input type="number" class="form-control score-input assignment" 
                                       value="{{ tc.assignment_score }}" min="0" max="100" step="0.01">
                            </td>
                            <td>
                                <input type="number" class="form-control score-input exam" 
                                       value="{{ tc.exam_score }}" min="0" max="100" step="0.01">
                            </td>
                            <td class="align-middle text-center">
                                <span class="badge bg-secondary total-score">{{ tc.total }}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4">No students found for this class and subject.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('scoresTable');
        const saveBtn = document.getElementById('saveScoresBtn');
        
        // Auto-calculate totals on input change
        table.addEventListener('input', function(e) {
            if (e.target.classList.contains('score-input')) {
                const row = e.target.closest('tr');
                calculateRowTotal(row);
                // Mark row as modified visually
                row.classList.add('table-warning');
            }
        });

        function calculateRowTotal(row) {
            const midsem = parseFloat(row.querySelector('.midsem').value) || 0;
            const quiz = parseFloat(row.querySelector('.quiz').value) || 0;
            const assignment = parseFloat(row.querySelector('.assignment').value) || 0;
            const exam = parseFloat(row.querySelector('.exam').value) || 0;
            
            const total = midsem + quiz + assignment + exam;
            const badge = row.querySelector('.total-score');
            
            badge.textContent = total.toFixed(2);
            
            // Color coding based on total
            badge.className = 'badge total-score ' + 
                (total >= 50 ? 'bg-success' : 'bg-danger');
            
            // Validation warning
            if (total > 100) {
                badge.className += ' border border-danger text-danger bg-light';
                alert('Warning: Total score exceeds 100% for ' + row.querySelector('td:nth-child(2)').innerText);
            }
        }

        // Save functionality
        saveBtn.addEventListener('click', function() {
            const scores = [];
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const id = row.getAttribute('data-id');
                if (!id) return;
                
                scores.push({
                    id: id,
                    midsem: row.querySelector('.midsem').value,
                    quiz: row.querySelector('.quiz').value,
                    assignment: row.querySelector('.assignment').value,
                    exam: row.querySelector('.exam').value
                });
            });

            // Show loading state
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;

            fetch("{% url 'save_scores' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ scores: scores })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove warning classes
                    rows.forEach(row => row.classList.remove('table-warning'));
                    alert('Success: ' + data.message);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving scores.');
            })
            .finally(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        });
    });
</script>
{% endblock js %}
