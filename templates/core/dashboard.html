{% extends 'base.html' %}
{% load i18n %}
{% block title %} {% trans 'Dashboard' %} | {% trans 'Learning management system' %} {% endblock title %}
{% load static %}

{% block header %}
{% endblock %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{% trans 'Dashboard' %}</li>
    </ol>
</nav>

{% include 'snippets/messages.html' %}

<div class="d-flex justify-content-between align-items-center mb-4">
	<h1 class="title-1">{% trans 'Dashboard' %}</h1>
    
    <!-- Division Filter Pills -->
    	<div class="btn-group" role="group" aria-label="Division Filter">
        <a href="?division=ALL" class="btn btn-outline-primary {% if selected_division == 'ALL' %}active{% endif %}">{% trans 'All' %}</a>
        <a href="?division=Nursery" class="btn btn-outline-primary {% if selected_division == 'Nursery' %}active{% endif %}">{% trans 'Nursery' %}</a>
        <a href="?division=Primary" class="btn btn-outline-primary {% if selected_division == 'Primary' %}active{% endif %}">{% trans 'Primary' %}</a>
        <a href="?division=JHS" class="btn btn-outline-primary {% if selected_division == 'JHS' %}active{% endif %}">{% trans 'JHS' %}</a>
    </div>
</div>

<div class="row users-count px-3">
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3 bg-white shadow-sm border-0 rounded-3">
			<h3><i class="fas fa-users text-secondary"></i></h3>
			<div class="text-right">
				{% trans 'Students' %}
				<h2 class="text-dark">{{ student_count }}</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3 bg-white shadow-sm border-0 rounded-3">
			<h3><i class="fas fa-chalkboard-teacher text-secondary"></i></h3>
			<div class="text-right">
				{% trans 'Teachers' %}
				<h2 class="text-dark">{{ lecturer_count }}</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3 bg-white shadow-sm border-0 rounded-3">
			<h3><i class="fas fa-user-shield text-secondary"></i></h3>
			<div class="text-right">
				{% trans 'Staff' %}
				<h2 class="text-dark">{{ superuser_count }}</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3 bg-white shadow-sm border-0 rounded-3">
			<h3><i class="fas fa-bus text-secondary"></i></h3>
			<div class="text-right">
				{% trans 'Bus Drivers' %}
				<h2 class="text-dark">0</h2>
			</div>
		</div>
	</div>
    <!-- Keeping other placeholders as 0 since they likely don't exist in DB yet -->
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3 bg-white shadow-sm border-0 rounded-3">
			<h3><i class="fas fa-utensils text-secondary"></i></h3>
			<div class="text-right">
				{% trans 'Canteen Staff' %}
				<h2 class="text-dark">0</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3 bg-white shadow-sm border-0 rounded-3">
			<h3><i class="fas fa-shield-alt text-secondary"></i></h3>
			<div class="text-right">
				{% trans 'Security' %}
				<h2 class="text-dark">0</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3 bg-white shadow-sm border-0 rounded-3">
			<h3><i class="fas fa-broom text-secondary"></i></h3>
			<div class="text-right pl-2">
				{% trans 'Cleaners' %}
				<h2 class="text-dark">0</h2>
			</div>
		</div>
	</div>
	<div class="col-6 col-md-3 mb-3 px-2">
		<div class="card-count p-3 bg-white shadow-sm border-0 rounded-3">
			<h3><i class="fas fa-users text-secondary"></i></h3>
			<div class="text-right">
				{% trans 'Others' %}
				<h2 class="text-dark">0</h2>
			</div>
		</div>
	</div>
</div>

<div class="row px-2">
	<div class="col-md-6 p-2">
		<div class="chart-wrap">
			<i class="fas fa-expand-alt"></i>
			<canvas id="traffic"></canvas>
		</div>
	</div>
	<div class="col-md-6 p-2">
		<div class="chart-wrap">
			<i class="fas fa-expand-alt"></i>
			<canvas id="enrollement"></canvas>
		</div>
	</div>
	<div class="col-md-6 p-2">
		<div class="chart-wrap">
            <!-- Renaming this chart as per new data -->
			<i class="fas fa-expand-alt"></i>
			<canvas id="staffing"></canvas> 
		</div>
	</div>
	<div class="col-md-6 p-2">
		<div class="card w-100 h-100 p-3">
			<h5>{% trans 'Latest activities' %}</h5>
			<ul class="ps-2 small">
				{% for log in logs %}
				<li>{{ log.message }} <span class="text-muted">- {{ log.created_at }}</span></li>
				{% empty %}
				<li>{% trans 'No recent activity' %}</li>
				{% endfor %}
			</ul>
		</div>
	</div>
</div>
<br>
<div class="bg-white p-3">
	<h5 class="border-bottom pb-2">{% trans 'School Demographics' %}</h5>
	<div class="row">
		<div class="col-md-6 mx-auto">
			<i class="fas fa-expand-alt"></i>
			<canvas id="gender"></canvas>
		</div>
	</div>
</div>

<script src="{% url 'javascript-catalog' %}"></script>
<script src="{% static 'js/dashboard.js' %}"></script>

<!-- Safer Data Passing -->
<script id="dashboard-data-payload" type="application/json">
    {
        "traffic": {{ traffic_data|safe }},
        "enrollment": {{ enrollment_data|safe }},
        "staffing": {{ staffing_data|safe }},
        "gender": {{ gender_data|safe }}
    }
</script>

<script>
    // Handle chart cleanup for HTMX/SPA navigation
    function safelyDestroyChart(canvasId) {
        try {
            const chart = Chart.getChart(canvasId);
            if (chart) {
                chart.destroy();
            }
        } catch (e) {
            console.error(e);
        }
    }

	$('.fa-expand-alt').click(function () {
		if ($(this).parent('.chart-wrap').parent('.col-md-6').hasClass('expand')) {
			$('.col-md-6.expand').removeClass('expand');
		}
		else {
			$('.col-md-6.expand')?.removeClass('expand');
			$(this).parent('.chart-wrap').parent('.col-md-6').addClass('expand');
		}
	})

    function initDashboardCharts() {
        if (typeof Chart === 'undefined') {
            console.warn("Chart.js not loaded yet.");
            return;
        }

        const payloadEl = document.getElementById('dashboard-data-payload');
        if (!payloadEl) return;
        
        let payload;
        try {
            payload = JSON.parse(payloadEl.textContent);
        } catch (e) {
            console.error("Failed to parse chart data", e);
            return;
        }

        const trafficData = payload.traffic;
        const enrollmentData = payload.enrollment;
        const staffingData = payload.staffing;
        const genderData = payload.gender;

        // 1. User Growth (Traffic)
        safelyDestroyChart('traffic');
        const trafficCanvas = document.getElementById('traffic');
        if (trafficCanvas) {
            new Chart(trafficCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: trafficData.labels,
                    datasets: [{
                        label: gettext('Students'),
                        backgroundColor: 'rgba(26, 115, 232, 0.1)', 
                        borderColor: '#1a73e8', 
                        borderWidth: 2,
                        pointBackgroundColor: '#1a73e8',
                        tension: 0.4,
                        data: trafficData.students
                    }, {
                        label: gettext('Teachers'),
                        backgroundColor: 'rgba(95, 99, 104, 0.1)', 
                        borderColor: '#5f6368', 
                        borderWidth: 2,
                        pointBackgroundColor: '#5f6368',
                        tension: 0.4,
                        data: trafficData.teachers
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: gettext('User Growth (Last 6 Months)'), padding: 20 },
                        legend: { position: 'top', align: 'end' }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f1f3f4' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 2. Enrollment by Level
        safelyDestroyChart('enrollement');
        const enrollmentCanvas = document.getElementById('enrollement');
        if (enrollmentCanvas) {
            new Chart(enrollmentCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: enrollmentData.labels,
                    datasets: [{
                        label: gettext('Students'),
                        backgroundColor: '#1a73e8', 
                        borderRadius: 4,
                        data: enrollmentData.data
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: gettext('Enrollment per Level'), padding: 20 },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f1f3f4' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 3. Teachers by Department
        safelyDestroyChart('staffing');
        const staffingCanvas = document.getElementById('staffing');
        if (staffingCanvas) {
            new Chart(staffingCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: staffingData.labels,
                    datasets: [{
                        label: gettext("Teachers"),
                        backgroundColor: '#da932c', 
                        borderRadius: 4,
                        data: staffingData.data
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: gettext('Teachers by Department'), padding: 20 },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f1f3f4' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 4. Demographics
        safelyDestroyChart('gender');
        const genderCanvas = document.getElementById('gender');
        if (genderCanvas) {
            new Chart(genderCanvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: genderData.labels,
                    datasets: [{
                        data: genderData.data,
                        backgroundColor: ['#1a73e8', '#fbbc04'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        title: { display: true, text: gettext('Student Gender Distribution'), padding: 20 },
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
    }

    // Initialize logic
    if (typeof htmx !== 'undefined') {
        htmx.onLoad(function(content) {
            initDashboardCharts();
        });
    } else {
        document.addEventListener('DOMContentLoaded', initDashboardCharts);
    }
    
    // Fallback: also try running immediately in case this script runs after DOMContentLoaded
    initDashboardCharts();

</script>

{% endblock content %}