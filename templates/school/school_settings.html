{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans 'School Settings' %} | {{ school.name }}{% endblock %}

{% block content %}
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, {{ school.primary_color|default:"#4f46e5" }}, {{ school.secondary_color|default:"#7c3aed" }});
    --glass-bg: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(255, 255, 255, 0.3);
  }

  /* Premium Background & Glassmorphism */
  body {
    background-color: #f8fafc;
    background-image: 
      radial-gradient(at 0% 0%, rgba(79, 70, 229, 0.05) 0px, transparent 50%),
      radial-gradient(at 100% 100%, rgba(124, 58, 237, 0.05) 0px, transparent 50%);
  }

  .settings-hero {
    background: var(--primary-gradient);
    border-radius: 1.5rem;
    color: #fff;
    padding: 3rem;
    margin-bottom: 2.5rem;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  .settings-hero::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -20%;
    width: 100%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
    transform: rotate(-15deg);
  }

  .settings-hero i.hero-bg-icon {
    font-size: 10rem;
    opacity: 0.1;
    position: absolute;
    right: -2rem;
    top: 50%;
    transform: translateY(-50%) rotate(-15deg);
  }

  .settings-card {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 1.5rem;
    box-shadow: 0 4px 24px rgba(0,0,0,0.04);
    padding: 2.5rem;
    transition: transform 0.3s ease;
  }

  /* Sidebar Navigation Polish */
  .settings-nav .nav-link {
    border-radius: 1rem;
    padding: 1rem 1.5rem;
    font-weight: 600;
    color: #64748b;
    margin-bottom: 0.5rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 0.8rem;
    border: 1px solid transparent;
  }

  .settings-nav .nav-link:hover {
    background: rgba(255, 255, 255, 0.5);
    color: #1e293b;
    transform: translateX(5px);
  }

  .settings-nav .nav-link.active {
    background: #fff;
    color: {{ school.primary_color|default:"#4f46e5" }};
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border-color: rgba(0,0,0,0.05);
  }

  .settings-nav .nav-link i {
    font-size: 1.1rem;
    width: 1.5rem;
    text-align: center;
  }

  /* Grade Weight Component Cards */
  .weight-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 1.25rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .weight-card:hover {
    border-color: {{ school.primary_color|default:"#4f46e5" }};
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.05);
  }

  .weight-card.disabled {
    background: #f1f5f9;
    border-color: #f1f5f9;
    opacity: 0.7;
  }

  .weight-card.disabled input {
    background: #e2e8f0;
    cursor: not-allowed;
  }

  .weight-card .icon-box {
    width: 3rem;
    height: 3rem;
    border-radius: 0.75rem;
    background: rgba(79, 70, 229, 0.1);
    color: {{ school.primary_color|default:"#4f46e5" }};
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
  }

  /* Custom Switches */
  .form-check-input:checked {
    background-color: {{ school.primary_color|default:"#4f46e5" }};
    border-color: {{ school.primary_color|default:"#4f46e5" }};
  }

  /* Total Progress Bar */
  .total-card {
    background: #fff;
    border-radius: 1.25rem;
    padding: 2rem;
    border-left: 5px solid;
    transition: border-color 0.3s ease;
  }

  .total-card.valid { border-left-color: #22c55e; }
  .total-card.invalid { border-left-color: #ef4444; }
  .total-card.warning { border-left-color: #f59e0b; }

  /* Promotion Visual Gauge */
  .promotion-gauge-container {
    position: relative;
    height: 60px;
    background: #f1f5f9;
    border-radius: 30px;
    margin: 2rem 0;
    overflow: hidden;
    display: flex;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
  }

  .gauge-segment {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 700;
    font-size: 0.85rem;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .gauge-segment::after {
    content: '';
    position: absolute;
    right: 0;
    height: 40%;
    width: 1px;
    background: rgba(255,255,255,0.3);
  }

  .segment-fail { background: #ef4444; }
  .segment-borderline { background: #f59e0b; }
  .segment-pass { background: #22c55e; }

  /* Better Tooltips/Hints */
  .hint-text {
    font-size: 0.85rem;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  /* Logo Image Polish */
  .logo-uploader {
    position: relative;
    width: 120px;
    height: 120px;
    border-radius: 1rem;
    border: 2px dashed #cbd5e1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .logo-uploader:hover {
    border-color: {{ school.primary_color|default:"#4f46e5" }};
    background: rgba(79, 70, 229, 0.02);
  }

  .logo-uploader img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  /* Animations */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .animate-fade-in {
    animation: fadeInUp 0.5s ease forwards;
  }

</style>

<div class="animate-fade-in">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">{% trans 'Home' %}</a></li>
      <li class="breadcrumb-item active fw-bold" style="color: {{ school.primary_color|default:"#4f46e5" }}">{% trans 'School Settings' %}</li>
    </ol>
  </nav>

  <div class="settings-hero">
    <i class="fas fa-cog hero-bg-icon"></i>
    <div class="position-relative">
      <h1 class="display-5 fw-bold mb-2">{% trans 'School Settings' %}</h1>
      <p class="fs-5 opacity-90 mb-0">
        {{ school.name }} &bull; {% trans 'Personalize identity and define academic standards' %}
      </p>
    </div>
  </div>

  {% include 'snippets/messages.html' %}

  <div class="row g-4">
    <!-- Sidebar Navigation -->
    <div class="col-lg-3">
      <div class="settings-card p-3">
        <h6 class="text-uppercase text-muted fw-bold small px-3 mb-3">{% trans 'Configuration' %}</h6>
        <div class="settings-nav d-flex flex-column">
          <a class="nav-link {% if active_tab == 'identity' %}active{% endif %}" href="{% url 'school_settings_identity' %}">
            <i class="fas fa-fingerprint"></i> {% trans 'General Identity' %}
          </a>
          <a class="nav-link {% if active_tab == 'grading' %}active{% endif %}" href="{% url 'school_settings_grading' %}">
            <i class="fas fa-chart-pie"></i> {% trans 'Grade Weights' %}
          </a>
          <a class="nav-link {% if active_tab == 'promotion' %}active{% endif %}" href="{% url 'school_settings_promotion' %}">
            <i class="fas fa-stairs"></i> {% trans 'Promotion Rules' %}
          </a>
          <div class="my-3 border-top mx-3"></div>
          <h6 class="text-uppercase text-muted fw-bold small px-3 mb-3">{% trans 'Operations' %}</h6>
          <a class="nav-link {% if active_tab == 'requests' %}active{% endif %}" href="{% url 'promotion_requests_list' %}">
            <i class="fas fa-bell"></i> {% trans 'Requests' %}
            {% if pending_count %}<span class="badge bg-danger rounded-pill ms-auto">{{ pending_count }}</span>{% endif %}
          </a>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="col-lg-9">
      <div class="settings-card">
        
        {% if active_tab == 'identity' %}
        {# ────────────────── IDENTITY SECTION ────────────────── #}
        <div class="d-flex align-items-center justify-content-between mb-4">
          <h3 class="fw-bold m-0 text-dark">{% trans 'Identity & Branding' %}</h3>
          <span class="badge bg-light text-dark border p-2">{% trans 'Admin Only' %}</span>
        </div>

        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="row g-4">
            <!-- Branding Visuals -->
            <div class="col-12">
              <div class="p-4 bg-light rounded-4 border">
                <h6 class="fw-bold mb-4 text-secondary">{% trans 'Visual Branding' %}</h6>
                <div class="row align-items-center g-4">
                  <div class="col-auto text-center">
                    <label class="d-block mb-3 small fw-bold">{% trans 'Main Logo' %}</label>
                    <div class="logo-uploader" onclick="document.getElementById('id_logo').click();">
                      {% if school.logo %}
                        <img src="{{ school.logo.url }}" alt="Logo">
                      {% else %}
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted"></i>
                      {% endif %}
                    </div>
                    <div style="display:none">{{ form.logo }}</div>
                  </div>
                  <div class="col-auto text-center">
                    <label class="d-block mb-3 small fw-bold">{% trans 'School Crest' %}</label>
                    <div class="logo-uploader" onclick="document.getElementById('id_secondary_logo').click();">
                      {% if school.secondary_logo %}
                        <img src="{{ school.secondary_logo.url }}" alt="Crest">
                      {% else %}
                        <i class="fas fa-shield-alt fa-2x text-muted"></i>
                      {% endif %}
                    </div>
                    <div style="display:none">{{ form.secondary_logo }}</div>
                  </div>
                  <div class="col">
                    <div class="row g-3">
                      <div class="col-md-4 text-center">
                        <label class="form-label small fw-bold">{% trans 'Primary Color' %}</label>
                        {{ form.primary_color }}
                      </div>
                      <div class="col-md-4 text-center">
                        <label class="form-label small fw-bold">{% trans 'Secondary' %}</label>
                        {{ form.secondary_color }}
                      </div>
                      <div class="col-md-4 text-center">
                        <label class="form-label small fw-bold">{% trans 'Accent' %}</label>
                        {{ form.accent_color }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Basic Information -->
            <div class="col-md-6">
              <label class="form-label fw-bold">{% trans 'School Name' %}</label>
              {{ form.name }}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">{% trans 'Motto' %}</label>
              {{ form.motto }}
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">{% trans 'Official Email' %}</label>
              {{ form.email }}
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">{% trans 'Phone Number' %}</label>
              {{ form.phone }}
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">{% trans 'Founded In' %}</label>
              {{ form.founded_year }}
            </div>
            <div class="col-md-8">
              <label class="form-label fw-bold">{% trans 'Address' %}</label>
              {{ form.address }}
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">{% trans 'Website' %}</label>
              {{ form.website }}
            </div>

            <div class="col-12 mt-5">
              <button type="submit" class="btn btn-lg w-100 fw-bold border-0 shadow-sm" style="background: var(--primary-gradient); color: #fff;">
                <i class="fas fa-check-circle me-2"></i> {% trans 'Save Identity Update' %}
              </button>
            </div>
          </div>
        </form>

        {% elif active_tab == 'grading' %}
        {# ────────────────── GRADING SECTION ────────────────── #}
        <div class="d-flex align-items-center justify-content-between mb-4">
          <div>
            <h3 class="fw-bold m-0 text-dark">{% trans 'Grade Weights' %}</h3>
            <p class="text-muted mb-0">{% trans 'Define the weight of continuous assessment and exams' %}</p>
          </div>
          <div class="text-end">
             <span class="d-block small text-muted text-uppercase fw-bold">{% trans 'Active Rules' %}</span>
             <span class="fs-4 fw-black" style="color: {{ school.primary_color|default:"#4f46e5" }}">100%</span>
          </div>
        </div>

        <form method="post" id="gradingForm">
          {% csrf_token %}
          
          <div class="total-card mb-5 shadow-sm" id="totalSummaryCard">
            <div class="row align-items-center">
              <div class="col">
                <h5 class="fw-bold mb-1">{% trans 'Total System Weight' %}</h5>
                <div id="statusMessage" class="small fw-semibold">{% trans 'Calculated automatically' %}</div>
              </div>
              <div class="col-auto">
                <div class="fs-2 fw-black" id="totalValue">--</div>
              </div>
              <div class="col-12 mt-3">
                <div class="progress rounded-pill" style="height: 12px; background: #eef2f6;">
                  <div id="totalProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-4">
            <!-- End of Term Exam (Mandatory) -->
            <div class="col-md-6">
              <div class="weight-card border-2">
                <div class="d-flex align-items-center gap-3 mb-3">
                  <div class="icon-box" style="background: rgba(124, 58, 237, 0.1); color: #7c3aed;">
                    <i class="fas fa-file-invoice"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h6 class="fw-bold mb-0">{% trans 'End of Term Exam' %}</h6>
                    <span class="badge bg-secondary rounded-pill small">{% trans 'Required' %}</span>
                  </div>
                </div>
                <div class="input-group input-group-lg">
                  {{ form.exam_weight }}
                  <span class="input-group-text bg-transparent border-start-0 text-muted">%</span>
                </div>
                <p class="small text-muted mt-2 mb-0">{% trans 'Primary weight for end-of-term assessment.' %}</p>
              </div>
            </div>

            <!-- Dynamic Components -->
            {% for toggle, weight, label_en, help_en, icon in component_data %}
            <div class="col-md-6" id="card_{{ weight.html_name }}">
              <div class="weight-card">
                <div class="d-flex align-items-center gap-3 mb-3">
                  <div class="icon-box">
                    <i class="{{ icon|default:'fas fa-tasks' }}"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h6 class="fw-bold mb-0">{{ label_en }}</h6>
                    <div class="form-check form-switch mt-1">
                      {{ toggle }}
                      <label class="form-check-label small text-muted">{% trans 'Use this component' %}</label>
                    </div>
                  </div>
                </div>
                <div class="input-group input-group-lg">
                  {{ weight }}
                  <span class="input-group-text bg-transparent border-start-0 text-muted">%</span>
                </div>
                <p class="small text-muted mt-2 mb-0">{{ help_en }}</p>
              </div>
            </div>
            {% endfor %}
          </div>

          <div class="col-12 mt-5">
            <button type="submit" id="saveWeightsBtn" class="btn btn-lg w-100 fw-bold shadow-sm" style="background: {{ school.primary_color|default:"#4f46e5" }}; color: #fff;">
              <i class="fas fa-save me-2"></i> {% trans 'Apply Grade System' %}
            </button>
          </div>
        </form>

        {% elif active_tab == 'promotion' %}
        {# ────────────────── PROMOTION SECTION ────────────────── #}
        <div class="d-flex align-items-center justify-content-between mb-4">
          <div>
            <h3 class="fw-bold m-0 text-dark">{% trans 'Promotion Rules' %}</h3>
            <p class="text-muted mb-0">{% trans 'Set performance bars for automatic progress' %}</p>
          </div>
        </div>

        <form method="post" id="promotionForm">
          {% csrf_token %}
          
          <div class="p-4 bg-light rounded-4 border mb-4">
            <h6 class="fw-bold text-center text-muted text-uppercase mb-4">{% trans 'Visual Policy Ribbon' %}</h6>
            <div class="promotion-gauge-container">
              <div id="segmentFail" class="gauge-segment segment-fail" style="width: 40%;">{% trans 'FAIL' %}</div>
              <div id="segmentBorderline" class="gauge-segment segment-borderline" style="width: 10%;">{% trans 'WAIT' %}</div>
              <div id="segmentPass" class="gauge-segment segment-pass" style="width: 50%;">{% trans 'PASS' %}</div>
            </div>
            <div class="d-flex justify-content-between px-2 small text-muted fw-bold">
              <span>0%</span>
              <span>100%</span>
            </div>
          </div>

          <div class="row g-4">
            <div class="col-md-6">
              <div class="card p-4 border-0 shadow-sm" style="background: rgba(34, 197, 94, 0.05); border-left: 4px solid #22c55e !important;">
                <label class="form-label fw-bold text-success mb-3">
                  <i class="fas fa-shield-check me-2"></i>{% trans 'Promotion Threshold' %}
                </label>
                <div class="input-group input-group-lg">
                  {{ form.promotion_cut_off }}
                  <span class="input-group-text bg-white border-start-0 text-muted">%</span>
                </div>
                <p class="small text-muted mt-3 mb-0">
                  {% trans 'Students with average' %} <strong>≥ <span id="valPromo">50</span>%</strong> {% trans 'will be automatically promoted.' %}
                </p>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card p-4 border-0 shadow-sm" style="background: rgba(239, 68, 68, 0.05); border-left: 4px solid #ef4444 !important;">
                <label class="form-label fw-bold text-danger mb-3">
                  <i class="fas fa-exclamation-triangle me-2"></i>{% trans 'Retention Threshold' %}
                </label>
                <div class="input-group input-group-lg">
                  {{ form.failure_cut_off }}
                  <span class="input-group-text bg-white border-start-0 text-muted">%</span>
                </div>
                <p class="small text-muted mt-3 mb-0">
                  {% trans 'Students with average' %} <strong>< <span id="valFail">40</span>%</strong> {% trans 'will automatically fail.' %}
                </p>
              </div>
            </div>

            <div class="col-md-6">
               <div class="p-3 border rounded-3 bg-white">
                 <div class="form-check form-switch mb-0">
                   {{ form.apply_to_all_terms }}
                   <label class="form-check-label fw-bold">{% trans 'Strict Multi-Term Evaluation' %}</label>
                 </div>
                 <p class="small text-muted mt-2 mb-0">{% trans 'If enabled, rule applies to every term independently.' %}</p>
               </div>
            </div>
            <div class="col-md-6">
               <div class="p-3 border rounded-3 bg-white">
                 <div class="form-check form-switch mb-0">
                   {{ form.allow_teacher_requests }}
                   <label class="form-check-label fw-bold">{% trans 'Manual Exceptions' %}</label>
                 </div>
                 <p class="small text-muted mt-2 mb-0">{% trans 'Allow teachers to submit requests for borderline students.' %}</p>
               </div>
            </div>

            <div class="col-12 mt-4">
              <button type="submit" class="btn btn-lg w-100 fw-bold border-0 shadow-sm" style="background: #1e293b; color: #fff;">
                <i class="fas fa-save me-2"></i> {% trans 'Save Promotion Policy' %}
              </button>
            </div>
          </div>
        </form>

        <div class="mt-5 pt-4 border-top">
          <div class="d-flex align-items-center justify-content-between mb-4">
            <h5 class="fw-bold m-0"><i class="fas fa-rocket me-2 text-primary"></i>{% trans 'Promotion Engine' %}</h5>
            <span class="small text-muted text-uppercase fw-bold">{% trans 'Current Term Only' %}</span>
          </div>
          <div class="alert alert-primary border-0 shadow-sm d-flex align-items-start gap-3 p-4">
            <i class="fas fa-info-circle fa-2x mt-1"></i>
            <div>
              <h6 class="fw-bold mb-1">{% trans 'Automated Evaluation' %}</h6>
              <p class="mb-3 small">{% trans 'Evaluate all results for the current term and automatically assign Pass/Fail based on the thresholds above.' %}</p>
              <form method="post" action="{% url 'run_promotion_engine' %}" onsubmit="return confirm('{% trans "Run engine for current term?" %}')">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary fw-bold px-4">
                  <i class="fas fa-play me-2"></i>{% trans 'Initiate Bulk Promotion' %}
                </button>
              </form>
            </div>
          </div>
        </div>

        {% endif %}

      </div>{# /settings-card #}
    </div>{# /col-lg-9 #}
  </div>{# /row #}
</div>{# /animate #}

{% endblock %}

{% block js %}
<script>
(function () {
  const primaryColor = "{{ school.primary_color|default:'#4f46e5' }}";

  // ── Grade Weight Logic ──
  const totalValEl = document.getElementById('totalValue');
  const progressBar = document.getElementById('totalProgressBar');
  const statusCard = document.getElementById('totalSummaryCard');
  const statusMsg = document.getElementById('statusMessage');
  const saveBtn = document.getElementById('saveWeightsBtn');

  function getVal(id) {
    const el = document.getElementById(id);
    return el ? (parseInt(el.value) || 0) : 0;
  }
  function isChecked(id) {
    const el = document.getElementById(id);
    return el ? el.checked : false;
  }

  function updateGradingUI() {
    if (!totalValEl) return;
    
    let total = getVal('id_exam_weight');
    const toggles = [
      ['id_use_classwork', 'id_classwork_weight'],
      ['id_use_class_test', 'id_class_test_weight'],
      ['id_use_assignment', 'id_assignment_weight'],
      ['id_use_attendance', 'id_attendance_weight'],
      ['id_use_project', 'id_project_weight']
    ];

    toggles.forEach(([tId, wId]) => {
      const active = isChecked(tId);
      const rowCard = document.getElementById('card_' + wId);
      const input = document.getElementById(wId);
      
      if (active) {
        total += getVal(wId);
        if (rowCard) rowCard.querySelector('.weight-card').classList.remove('disabled');
        if (input) input.disabled = false;
      } else {
        if (rowCard) rowCard.querySelector('.weight-card').classList.add('disabled');
        if (input) input.disabled = true;
      }
    });

    totalValEl.textContent = total + '%';
    progressBar.style.width = Math.min(total, 100) + '%';
    
    if (total === 100) {
      statusCard.className = 'total-card mb-5 shadow-sm valid';
      progressBar.className = 'progress-bar bg-success progress-bar-striped progress-bar-animated';
      statusMsg.textContent = '✓ System ready to apply';
      if (saveBtn) saveBtn.disabled = false;
    } else if (total > 100) {
      statusCard.className = 'total-card mb-5 shadow-sm invalid';
      progressBar.className = 'progress-bar bg-danger';
      statusMsg.textContent = '✗ Total exceeds 100%';
      if (saveBtn) saveBtn.disabled = true;
    } else {
      statusCard.className = 'total-card mb-5 shadow-sm warning';
      progressBar.className = 'progress-bar bg-warning';
      statusMsg.textContent = `◆ ${100 - total}% remaining`;
      if (saveBtn) saveBtn.disabled = true;
    }
  }

  // Bind Listeners
  const ids = [
    'id_exam_weight', 'id_classwork_weight', 'id_class_test_weight', 
    'id_assignment_weight', 'id_attendance_weight', 'id_project_weight',
    'id_use_classwork', 'id_use_class_test', 'id_use_assignment', 
    'id_use_attendance', 'id_use_project'
  ];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', updateGradingUI);
    if (el && el.type === 'checkbox') el.addEventListener('change', updateGradingUI);
  });
  updateGradingUI();


  // ── Promotion Policy Logic ──
  const promoInput = document.getElementById('id_promotion_cut_off');
  const failInput = document.getElementById('id_failure_cut_off');
  const segFail = document.getElementById('segmentFail');
  const segBorder = document.getElementById('segmentBorderline');
  const segPass = document.getElementById('segmentPass');
  const valPromo = document.getElementById('valPromo');
  const valFail = document.getElementById('valFail');

  function updatePromotionUI() {
    if (!promoInput || !failInput) return;
    const p = parseFloat(promoInput.value) || 0;
    const f = parseFloat(failInput.value) || 0;

    valPromo.textContent = p;
    valFail.textContent = f;

    const failW = Math.max(0, f);
    const borderW = Math.max(0, p - f);
    const passW = Math.max(0, 100 - p);

    segFail.style.width = failW + '%';
    segBorder.style.width = borderW + '%';
    segPass.style.width = passW + '%';

    segFail.textContent = failW > 15 ? '{% trans "FAIL" %}' : '';
    segBorder.textContent = borderW > 15 ? '{% trans "WAIT" %}' : '';
    segPass.textContent = passW > 15 ? '{% trans "PASS" %}' : '';
  }

  if (promoInput) promoInput.addEventListener('input', updatePromotionUI);
  if (failInput) failInput.addEventListener('input', updatePromotionUI);
  updatePromotionUI();

})();
</script>
{% endblock %}
